# Keystore 私钥存储系统

本模块负责管理加密货币密钥对的私钥存储，实现了将私钥存储在文件系统而非数据库中的安全实践。

## 设计理念

1. **安全优先**：私钥是区块链资产安全的核心，不应存储在数据库中，以减少数据泄露风险
2. **文件系统存储**：将私钥存储在文件系统中，并使用严格的文件权限（0600）保护
3. **可扩展性**：设计支持未来集成到MPC（多方计算）服务中
4. **地址索引**：通过地址作为索引来查找对应的私钥文件

## 实现架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   KeyService    │────▶│   Keystore      │────▶│ 文件系统 (data/  │
│                 │     │                 │     │  keystore/)     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                      │
        ▼                      ▼
┌─────────────────┐     ┌─────────────────┐
│   数据库        │     │  加密功能       │
│ (不存储私钥)    │     │ (可选)          │
└─────────────────┘     └─────────────────┘
```

## 使用流程

1. **生成密钥对**：
   - KeyService调用crypto模块生成密钥对
   - 将私钥通过Keystore保存到文件系统
   - 将公钥和地址等信息保存到数据库

2. **签名交易**：
   - TransactionService从数据库获取KeyPair信息（不含私钥）
   - 通过KeyService从Keystore获取对应的私钥
   - 使用私钥进行交易签名

3. **文件命名规则**：
   - 私钥文件命名格式：`key_[address].txt`
   - 存储路径：`./data/keystore/`

## 安全特性

1. **文件权限**：私钥文件使用0600权限，仅允许文件所有者读写
2. **目录权限**：keystore目录使用0700权限，仅允许目录所有者访问
3. **可选加密**：提供EncryptPrivateKey和DecryptPrivateKey函数，支持对私钥进行AES加密存储
4. **事务性操作**：在生成密钥对时，确保数据库记录和文件系统存储的一致性

## 未来扩展方向

1. **MPC集成**：计划支持将私钥存储迁移到MPC（多方计算）服务中
2. **硬件钱包集成**：支持与硬件钱包设备交互
3. **HSM支持**：集成硬件安全模块
4. **密钥分片**：实现基于Shamir秘密共享的密钥分片存储
5. **多重签名**：支持多设备或多人授权的多重签名机制

## 注意事项

1. **备份重要性**：请确保定期备份`data/keystore`目录
2. **密码管理**：在生产环境中，请使用EncryptPrivateKey函数加密私钥，并妥善保管加密密码
3. **权限控制**：确保只有必要的服务和用户能够访问keystore目录
4. **环境隔离**：在不同环境（开发、测试、生产）使用不同的keystore目录